let calendar,currentView="calendar",eventos=[];document.addEventListener("DOMContentLoaded",function(){initializeCalendar(),initializeEventListeners(),loadEventosAjax()});function initializeCalendar(){const e=document.getElementById("calendar");if(!e)return;calendar=new FullCalendar.Calendar(e,{initialView:"dayGridMonth",locale:"es",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay,listWeek"},buttonText:{today:"Hoy",month:"Mes",week:"Semana",day:"DÃ­a",list:"Lista"},events:eventos,eventClick:handleEventClick,eventDrop:handleEventDrop,eventResize:handleEventResize,editable:!0,selectable:!0,selectMirror:!0,dayMaxEvents:!0,weekends:!0,height:"auto",eventTimeFormat:{hour:"2-digit",minute:"2-digit",meridiem:!1}}),calendar.render()}function initializeEventListeners(){const e=document.getElementById("btnAgendaView");e&&e.addEventListener("click",toggleAgendaView);const t=document.getElementById("fabCrearEvento");t&&t.addEventListener("click",()=>{const e=document.getElementById("crearEventoModal");e&&new bootstrap.Modal(e).show()}),initializeModals()}function loadEventosAjax(){fetch("/events/json").then(e=>e.json()).then(e=>{eventos=e,calendar&&(calendar.removeAllEvents(),calendar.addEventSource(eventos))}).catch(e=>console.error("Error cargando eventos:",e))}function handleEventClick(e){const t=e.event,n=document.getElementById("editarEventoModal");if(n){document.getElementById("editEventoId").value=t.id,document.getElementById("editTitulo").value=t.title,document.getElementById("editDescripcion").value=t.extendedProps.descripcion||"",document.getElementById("editFechaInicio").value=t.start.toISOString().slice(0,16),document.getElementById("editFechaFin").value=t.end?t.end.toISOString().slice(0,16):"",document.getElementById("editUbicacion").value=t.extendedProps.ubicacion||"",document.getElementById("editUrlVirtual").value=t.extendedProps.url_virtual||"",new bootstrap.Modal(n).show()}}function handleEventDrop(e){const t=e.event;updateEventoAjax(t.id,{fecha_inicio:t.start.toISOString(),fecha_fin:t.end?t.end.toISOString():t.start.toISOString()})}function handleEventResize(e){const t=e.event;updateEventoAjax(t.id,{fecha_inicio:t.start.toISOString(),fecha_fin:t.end.toISOString()})}function updateEventoAjax(e,t){fetch(`/admin/events/${e}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify(t)}).then(e=>e.json()).then(e=>{e.success?showNotification("Evento actualizado exitosamente","success"):(showNotification("Error al actualizar evento","error"),calendar.refetchEvents())}).catch(e=>{console.error("Error:",e),showNotification("Error al actualizar evento","error"),calendar.refetchEvents()})}function toggleAgendaView(){const e=document.getElementById("calendar"),t=document.getElementById("agendaView"),n=document.getElementById("btnAgendaView");"calendar"===currentView?(e.classList.add("d-none"),t.classList.remove("d-none"),n.innerHTML='<i class="ri-calendar-line"></i> Ver calendario',currentView="agenda",renderAgendaView()):(e.classList.remove("d-none"),t.classList.add("d-none"),n.innerHTML='<i class="ri-list-check-line"></i> Ver agenda',currentView="calendar")}function renderAgendaView(){const e=document.getElementById("agendaList");if(!e)return;e.innerHTML="";const t={};eventos.forEach(e=>{const n=new Date(e.start).toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"});t[n]||(t[n]=[]),t[n].push(e)}),Object.keys(t).sort().forEach(e=>{const n=document.createElement("div");n.className="list-group-item list-group-item-secondary fw-bold",n.textContent=e.charAt(0).toUpperCase()+e.slice(1),agendaList.appendChild(n),t[e].forEach(e=>{const t=document.createElement("div");t.className="list-group-item d-flex justify-content-between align-items-start",t.innerHTML=`<div class="ms-2 me-auto"><div class="fw-bold">${e.title}</div><small class="text-muted">${e.extendedProps.descripcion||""}</small></div><span class="badge bg-primary rounded-pill" style="background-color: ${e.color} !important;">${new Date(e.start).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})}</span>`,t.addEventListener("click",()=>handleEventClick({event:e})),agendaList.appendChild(t)})})}function initializeModals(){const e=document.getElementById("crearEventoForm");e&&e.addEventListener("submit",handleCrearEvento);const t=document.getElementById("editarEventoForm");t&&t.addEventListener("submit",handleEditarEvento);const n=document.getElementById("solicitudCitaForm");n&&n.addEventListener("submit",handleSolicitudCita);const o=document.getElementById("solicitudCitaAiForm");o&&o.addEventListener("submit",handleSolicitudCitaAi)}function handleCrearEvento(e){e.preventDefault();const t=new FormData(e.target);fetch("/eventos",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:t}).then(e=>e.json()).then(e=>{e.success?(showNotification("Evento creado exitosamente","success"),bootstrap.Modal.getInstance(document.getElementById("crearEventoModal")).hide(),t.reset(),loadEventosAjax()):showNotification(e.message||"Error al crear evento","error")}).catch(e=>{console.error("Error:",e),showNotification("Error al crear evento","error")})}function handleEditarEvento(e){e.preventDefault();const t=document.getElementById("editEventoId").value,n=new FormData(e.target);fetch(`/admin/events/${t}`,{method:"PUT",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:n}).then(e=>e.json()).then(e=>{e.success?(showNotification("Evento actualizado exitosamente","success"),bootstrap.Modal.getInstance(document.getElementById("editarEventoModal")).hide(),loadEventosAjax()):showNotification(e.message||"Error al actualizar evento","error")}).catch(e=>{console.error("Error:",e),showNotification("Error al actualizar evento","error")})}function handleSolicitudCita(e){e.preventDefault();const t=new FormData(e.target);fetch("/solicitud-cita",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:t}).then(e=>e.json()).then(e=>{e.success?(showNotification("Solicitud enviada exitosamente","success"),bootstrap.Modal.getInstance(document.getElementById("solicitudCitaModal")).hide(),t.reset()):showNotification(e.message||"Error al enviar solicitud","error")}).catch(e=>{console.error("Error:",e),showNotification("Error al enviar solicitud","error")})}function handleSolicitudCitaAi(e){e.preventDefault();const t=new FormData(e.target);fetch("/ai/appointments/suggest",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:t}).then(e=>e.json()).then(e=>{e.success?showNotification("Sugerencia de cita generada exitosamente","success"):showNotification(e.message||"Error al generar sugerencia","error")}).catch(e=>{console.error("Error:",e),showNotification("Error al generar sugerencia","error")})}function showNotification(e,t="info"){console.log(`${t.toUpperCase()}: ${e}`),"error"===t?alert(`Error: ${e}`):alert(e)}document.addEventListener("DOMContentLoaded",function(){const e=document.querySelectorAll('input[type="datetime-local"]');e.forEach(e=>{flatpickr(e,{enableTime:!0,dateFormat:"Y-m-d H:i",locale:"es",time_24hr:!0})})}); 